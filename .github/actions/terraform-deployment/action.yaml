name: 'Terraform operations'
description: 'Runs Terraform setup and operations'
inputs:
  flow:
    description: 'This identifies whether it is a PR flow or Push flow'
    required: true
    default: plan
  working_dir:
    description: 'Working Directory for terraform commands'
    required: true
  rolename:
    description: 'Role for s3 bucket access'
    required: true
runs:
  using: composite
  steps:
  - name: Setup Terraform
    uses: hashicorp/setup-terraform@v3
    with:
      terraform_version: "~1.12.0"
  - name: Initialize Terraform
    run: |
      cd ${{ inputs.working_dir }}
      terraform init
    shell: bash 
  - name: Check format
    run: |
      cd ${{ inputs.working_dir }}
      terraform fmt -check -recursive
    shell: bash
  - name: Validate Terraform
    run: |
      cd ${{ inputs.working_dir }}
      terraform validate
    shell: bash
  - name: Export Environment Variables
    run: |
      echo "TF_VAR_rolename=${{ inputs.rolename }}" >> GITHUB_ENV
    shell: bash
  - name: Run Plan (PR)
    if: ${{ inputs.flow }} == 'plan'
    run: |
      cd ${{ inputs.working_dir }}
      terraform plan -input=false
    shell: bash
  - name: Run Plan (Push)
    if: ${{ inputs.flow }} == 'push'
    run: |
      cd ${{ inputs.working_dir }}
      terraform plan -input=false -out oidc-plan.tfplan
    shell: bash
  - name: Run Apply
    if: ${{ inputs.flow }} == 'push'
    run: |
      cd ${{ inputs.working_dir }}
      terraform apply -input=false oidc-plan.tfplan
    shell: bash
    
    